<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<style>
body {
  background: #063b0d;
  font-family: Arial;
  color: white;
  padding: 20px;
}
.box {
  background: #0d5f18;
  padding: 15px;
  border-radius: 10px;
  margin-bottom: 20px;
}
input, select {
  width: 95%;
  padding: 10px;
  border-radius: 10px;
  border: none;
  margin: 5px 0;
}
button {
  width: 100%;
  padding: 12px;
  background: #d11;
  border: none;
  border-radius: 10px;
  color: white;
  font-size: 18px;
  margin-top: 10px;
  cursor: pointer;
}
table {
  width: 100%;
  margin-top: 15px;
  border-collapse: collapse;
}
td, th {
  padding: 10px;
  border-bottom: 1px solid #ffffff44;
}
</style>
</head>

<body>

<h2>Admin Dashboard</h2>

<div class="box">
  <h3>Manage Balance</h3>

  <select id="userSelect"></select>

  <input id="amount" type="number" placeholder="Amount">

  <button onclick="deposit()">Add Balance</button>
  <button onclick="withdraw()">Withdraw Balance</button>

  <h3>Current Balance</h3>
  <div id="currentBalance">Select a user</div>
</div>

<div class="box">
  <h3>Operations Historique</h3>
  <table>
    <thead>
      <tr>
        <th>User</th>
        <th>Type</th>
        <th>Amount</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody id="historyTable"></tbody>
  </table>
</div>

<script>
const BIN_ID = "692eeefbae596e708f7e9e72";
const API_KEY = "$2a$10$hCALb9EdUjLfi38M4RhCMOdm8.1y36yYtLvW0BYdZTfqjpHtlAY7S";

// ------------------------

async function getData() {
  let r = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
    headers: {"X-Master-Key": API_KEY}
  });
  let data = await r.json();
  return data.record;
}

async function saveData(data) {
  await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      "X-Master-Key": API_KEY
    },
    body: JSON.stringify(data)
  });
}

async function load() {
  let db = await getData();
  let users = db.users;

  let select = document.getElementById("userSelect");
  select.innerHTML = "";

  Object.keys(users).forEach(user => {
    if (user !== "admin") {
      select.innerHTML += `<option>${user}</option>`;
    }
  });

  updateBalance();
  loadHistory();
}

async function updateBalance() {
  let db = await getData();
  let user = document.getElementById("userSelect").value;
  let bal = db.users[user].balance;

  document.getElementById("currentBalance").innerHTML = bal + " TD";
}

async function deposit() {
  let db = await getData();
  let user = userSelect.value;
  let amount = Number(document.getElementById("amount").value);

  if (amount <= 0) return alert("Invalid amount");

  db.users[user].balance += amount;

  db.history.push({
    user: user,
    type: "Deposit",
    amount: amount,
    date: new Date().toLocaleString()
  });

  await saveData(db);
  updateBalance();
  loadHistory();
  alert("Balance added");
}

async function withdraw() {
  let db = await getData();
  let user = userSelect.value;
  let amount = Number(document.getElementById("amount").value);

  if (amount <= 0) return alert("Invalid amount");
  if (db.users[user].balance < amount) return alert("Not enough balance");

  db.users[user].balance -= amount;

  db.history.push({
    user: user,
    type: "Withdraw",
    amount: amount,
    date: new Date().toLocaleString()
  });

  await saveData(db);
  updateBalance();
  loadHistory();
  alert("Balance withdrawn");
}

async function loadHistory() {
  let db = await getData();
  let table = document.getElementById("historyTable");
  table.innerHTML = "";

  db.history.slice().reverse().forEach(op => {
    table.innerHTML += `
      <tr>
        <td>${op.user}</td>
        <td>${op.type}</td>
        <td>${op.amount} TD</td>
        <td>${op.date}</td>
      </tr>
    `;
  });
}

document.getElementById("userSelect").addEventListener("change", updateBalance);
load();
</script>

</body>
</html>
