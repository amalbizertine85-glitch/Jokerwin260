<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<style>
    body { background:#004b1f; color:white; font-family:Arial; text-align:center; }
    .box { background:#013d18; padding:20px; width:90%; margin:20px auto; border-radius:15px; }
    input, select {
        width:90%; padding:12px; margin:8px 0; border-radius:10px; border:none; font-size:16px;
    }
    button { width:45%; padding:12px; font-size:16px; border:none; border-radius:10px; margin:5px; }
    .add { background:#ff9d00; color:black; }
    .withdraw { background:#ff0000; color:white; }
    .create { background:#00ff62; color:black; width:90%; }
    table { width:100%; margin-top:20px; color:white; }
</style>
</head>
<body>

<h1>Dashboard</h1>
<p>Manage users, deposit/withdraw and create accounts</p>

<div class="box">
    <h3>Select user</h3>
    <select id="userSelect"></select>

    <h3>Amount</h3>
    <input id="amount" type="number" placeholder="Amount">

    <button class="add" onclick="addBalance()">Add Balance</button>
    <button class="withdraw" onclick="withdrawBalance()">Withdraw Balance</button>

    <h2>Current Balance</h2>
    <p id="currentBalance">0.00 TD</p>
</div>

<div class="box">
    <h3>Create Account</h3>
    <input id="newUser" placeholder="Enter username">
    <button class="create" onclick="createAccount()">Create Account</button>
</div>

<div class="box">
    <h3>Operations Historique</h3>
    <table id="historyTable">
        <tr><th>User</th><th>Type</th><th>Amount</th><th>Date</th></tr>
    </table>
</div>

<script>
const BIN_ID = "692eeefbae596e708f7e9e72";
const API_KEY = "$2a$10$hCALb9EdUjLfi38M4RhCMOdm8.1y36yYtLvW0BYdZTfqjpHtlAY7S";

async function loadUsers() {
    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
        headers: { "X-Master-Key": API_KEY }
    });
    const data = await res.json();
    const users = data.record;

    let select = document.getElementById("userSelect");
    select.innerHTML = "";

    for (let u of users) {
        let opt = document.createElement("option");
        opt.value = u.username;
        opt.textContent = u.username;
        select.appendChild(opt);
    }
    updateBalanceDisplay(users);
}

async function updateBalanceDisplay(users = null) {
    if (!users) {
        const r = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
            headers: { "X-Master-Key": API_KEY }
        });
        users = (await r.json()).record;
    }

    let user = document.getElementById("userSelect").value;
    let found = users.find(u => u.username === user);

    document.getElementById("currentBalance").textContent =
        found ? found.balance.toFixed(2) + " TD" : "0.00 TD";

    loadHistory(found ? found.history : []);
}

function loadHistory(history) {
    let table = document.getElementById("historyTable");
    table.innerHTML = `<tr><th>User</th><th>Type</th><th>Amount</th><th>Date</th></tr>`;
    if (!history) return;

    history.forEach(h => {
        table.innerHTML += `<tr>
            <td>${h.user}</td>
            <td>${h.type}</td>
            <td>${h.amount}</td>
            <td>${h.date}</td>
        </tr>`;
    });
}

async function saveData(list) {
    await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
        method: "PUT",
        headers: {
            "Content-Type": "application/json",
            "X-Master-Key": API_KEY
        },
        body: JSON.stringify(list)
    });
}

async function addBalance() {
    let amount = Number(document.getElementById("amount").value);
    let user = document.getElementById("userSelect").value;

    if (!amount) return alert("Enter amount");

    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
        headers: { "X-Master-Key": API_KEY }
    });
    let list = (await res.json()).record;

    let u = list.find(x => x.username === user);
    u.balance += amount;
    u.history.push({ user, type: "Deposit", amount, date: new Date().toLocaleString() });

    await saveData(list);
    loadUsers();
}

async function withdrawBalance() {
    let amount = Number(document.getElementById("amount").value);
    let user = document.getElementById("userSelect").value;

    if (!amount) return alert("Enter amount");

    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
        headers: { "X-Master-Key": API_KEY }
    });
    let list = (await res.json()).record;

    let u = list.find(x => x.username === user);
    if (u.balance < amount) return alert("Not enough balance");

    u.balance -= amount;
    u.history.push({ user, type: "Withdraw", amount, date: new Date().toLocaleString() });

    await saveData(list);
    loadUsers();
}

async function createAccount() {
    let username = document.getElementById("newUser").value;
    if (!username) return alert("Enter username");

    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
        headers: { "X-Master-Key": API_KEY }
    });
    let list = (await res.json()).record;

    if (list.find(x => x.username === username))
        return alert("User already exists!");

    list.push({
        username,
        balance: 0,
        history: []
    });

    await saveData(list);
    document.getElementById("newUser").value = "";
    loadUsers();
    alert("Account created!");
}

loadUsers();
</script>

</body>
</html>
